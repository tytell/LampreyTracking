---
title: "Process A2 midlines"
output: html_notebook
---

```{r setup}
library(tidyverse)
# library(signal)
library(plotly)
library(patchwork)
library(ggbeeswarm)
library(hdf5r)
```

This is a script with the kinematics processing code.
```{r}
source('process_midlines.R')
source('check_midlines.R')
```

Directory where all the tracked data files are stored.
```{r}
boxdir <- '/Users/etytel01/Box/Katz lamprey kinematics'
datadir <- file.path(boxdir,'2021/Processed Data/Exp_062921')
```

Names of the treatments.
```{r}
treatments = c("Control", "2hpi", "1dpi", "2dpi", "3dpi")
```

Body parts are named in DeepLabCut, but they have an order along the body, given here.
```{r}
bodypartorder = c("snout", "gill", "mid1", "mid2", "anus", "mid4", "tailbase", "tailtip")
```

Filming speed (frames per second)
```{r}
fps = 60
```

Load in approximate widthdata for ammocoetes, which we'll use for locating the center of mass.
```{r}
widthdata <- read_csv(file.path(boxdir,'2021/fishwidth.csv'))
```

Digitized scales for each day of filming.
```{r}
scalefile <- file.path(boxdir,'2021/Processed Data/scales.csv')
```

```{r}
scales <- read_csv(scalefile, col_types = list(Date = col_date("%Y-%m-%d"),
                                               Animal = col_character(),
                                               Treatment = col_factor(levels = treatments)))
scales
```

# Load the DeepLabCut data and process it

```{r}
datafilenames <- list.files(datadir, pattern='*.csv', full.names = TRUE, recursive = TRUE)
datafilenames <- datafilenames[str_detect(datafilenames, 'shuffle1')]
```

```{r}
datafilenames <- datafilenames[str_detect(datafilenames, 'A2')]
```

## Load and process the data

Note that these chunks don't run by default, since they take a long time.

```{r eval = FALSE}
#options(error = recover)
data <- purrr::map_dfr(datafilenames, ~ load_katz_data(.x, scales = scales,
                                                       widthdata = widthdata$ammowidth, fps = fps,
                                                       bodypartorder = bodypartorder, showfile = TRUE))

data <- data %>%
  distinct()

write_csv(data, file.path(boxdir,'2021/Processed Data/A2data.csv'))
```

This loads the previous processed data file, as produced above.
```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A2data.csv'),
                                  col_types = list(Animal = col_character(),
                                  Treatment = col_factor(levels = treatments),
                                  bodyparts = col_factor(levels = bodypartorder)))
```

```{r}
head(data)
```

```{r}
data %>%
  filter(trial == '063021_A2V14_03')
```

```{r}
data %>%
  filter(trial == '063021_A2V14_03') %>%
  filter((frame >= 50) & (frame <= 70)) %>%
  ggplot(aes(x = xmm, y = ymm, color = frame)) +
  geom_path(aes(group = frame))
```


## Look for bad frames

Look for variation in length
```{r}
animallengths <-
  data %>%
  group_by(trial) %>%
  get_arc_length() %>%
  group_by(Animal, trial, frame) %>%
  summarize(lenfr = last(s)) %>%
  ungroup() %>%
  group_by(Animal) %>%
  mutate(len = median(lenfr)) %>%
  ungroup()
```

```{r}
animallengths %>%
  filter(trial == '063021_A2V14_03') %>%
  ggplot(aes(x = frame, y = lenfr)) +
  geom_point()
```

```{r}
data <-
  data %>%
  left_join(animallengths, by = c("Animal","trial","frame"))
```

This also takes a long time
```{r eval=FALSE}
data <-
  data %>%
  get_point_order()
write_csv(data, file.path(boxdir,'2021/Processed Data/A2data.csv'))
```

```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A2data.csv'), 
                 col_types = list(Animal = col_character(),
                                  Treatment = col_factor(levels = treatments),
                                  bodyparts = col_factor(levels = bodypartorder)))
```

```{r}
data <-
  data %>%
  group_by(trial, frame) %>%
  mutate(pointorder = seq_len(n())) %>%
  mutate(goodpointorder = all(nextpoint == pointorder+1, na.rm=TRUE),
            goodlength = all(abs(lenfr - len) / len < 0.1))
```

```{r}
data %>%
  group_by(trial) %>%
  summarize(pctgoodlength = sum(as.numeric(goodlength), na.rm = TRUE) / n(),
            pctgoodpointorder = sum(as.numeric(goodpointorder), na.rm = TRUE) / n()) %>%
  ggplot(aes(x = trial)) +
  geom_point(aes(y = pctgoodlength)) +
  geom_point(aes(y = pctgoodpointorder), color = 'red', shape = 5) +
  theme(axis.text.x = element_blank())
```

## Process the kinematics for the good frames

```{r}
if ('dx' %in% colnames(data)) {
  data <- data %>%
    select(-(dx:wavelength))
}
```

```{r eval = FALSE}
data <-
  data %>%
  ungroup() %>%
  filter(goodpointorder & goodlength) %>%
  group_by(filename) %>%
  group_modify(~ get_all_kinematics(.x, widthdata = widthdata$ammowidth))
write_csv(data, file.path(boxdir,'2021/Processed Data/A2data-goodframes.csv'))
```


# Plot kinematics

```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A2data-goodframes.csv'),
                 col_types = list(Date = col_date(), 
                                  Date.x = col_date(), 
                                  Animal = col_character(),
                                  Treatment = col_factor(levels = treatments),
                                  bodyparts = col_factor(levels = bodypartorder)))

if ('Date.y' %in% colnames(data)) {
  data <- data %>%
    select(-Date.y) %>%
    rename(Date = Date.x)
}
```

```{r}
data %>%
  plot_ly(x = ~t, y = ~swimvels, color = ~trial, type = 'scatter', mode = 'lines') %>%
  layout(showlegend = FALSE)
```

```{r}
tailbeatdata <-
  data %>%
  arrange(trial, frame, bodyparts) %>%
  group_by(trial, frame) %>%
  dplyr::rename(swimvel0 = swimvel, swimvel = swimvels) %>%
  summarize(across(c(freq,swimvel, Treatment, len, amp, wavespeed, wavelength), ~ last(na.omit(.x))))

```

```{r}
data %>%
  filter(freq > 10 & Treatment == 'Control') %>%
  distinct(trial)
```

```{r}
q <-data %>%
  select(-(dx:wavelength)) %>%
  filter(trial == '062921_A2V8_02') %>%
  get_all_kinematics(widthdata = widthdata$ammowidth)
  

q %>% filter(bodyparts == 'tailtip') %>%
  #group_by(frame) %>%
  plot_ly(x = ~t, y = ~excs / len, type = 'scatter', mode = 'lines+markers') %>%
  add_markers(x = ~t, y = ~excs / len, color = ~factor(peak))
```

```{r}
q <- 
  data %>%
  select(-contains('bodyaxis')) %>%
  filter(trial == '062921_A2V8_02') %>%
  get_body_axis() 
```

```{r}
q %>%
  filter(bodyparts == 'tailtip') %>%
  plot_ly(x = ~t, y = ~bodyaxisxfr, type = 'scatter', mode = 'lines+markers')
```

```{r}
tailbeatdata %>%
  ggplot(aes(x = freq, y = swimvel, color = Treatment)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ Treatment, scales = 'free')
  # lims(x = c(0, 20), y = c(0, 400))
  # layout(showlegend = FALSE)
```
```{r}
tailbeatdata %>%
  mutate(stridelen = swimvel/len / freq) %>%
  ggplot(aes(x = swimvel, y = stridelen, color = Treatment)) +
  geom_point() +
  facet_wrap(~Treatment) +
  lims(x = c(0, 400), y = c(0, 2))
```

```{r}
tailbeatdata %>%
  ggplot(aes(x = swimvel, y = amp, color = Treatment)) +
  geom_point() +
  facet_wrap(~Treatment)
```
```{r}
tailbeatdata %>%
  mutate(St = 2*freq*amp / swimvel) %>%
  ggplot(aes(x = swimvel, y = St, color = Treatment)) +
  geom_point() +
  facet_wrap(~Treatment) +
  ylim(0,1)
```
```{r}
tailbeatdata %>%
  ggplot(aes(x = swimvel, y = wavespeed, color = Treatment)) +
  geom_point() +
  facet_wrap(~Treatment) +
  ylim(0, 400)
```

```{r}
tailbeatdata %>%
  ggplot(aes(x = swimvel, y = wavelength, color = Treatment)) +
  geom_point() +
  facet_wrap(~Treatment)
```

