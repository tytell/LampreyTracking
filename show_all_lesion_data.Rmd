---
title: "Show all lesion data"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(patchwork)
library(lubridate)
```

```{r}
source('process_midlines.R')
```

Directory where the data files are stored.
```{r}
boxdir <- '/Users/etytel01/Box/Katz lamprey kinematics/2021/Processed Data'
```

```{r}
datafiles <- c('A1data-goodframes.csv',
               'A2data-goodframes.csv',
               'A20803data-goodframes.csv',
               'A21009data-goodframes.csv')

treatments <- c('medial', 'bilateral', 'medial', 'bilateral')
```

Names of the time points.
```{r}
timepoints = c("Control", "2hpi", "1dpi", "2dpi", "3dpi")
```

Body parts are named in DeepLabCut, but they have an order along the body, given here.
```{r}
bodypartorder = c("snout", "gill", "mid1", "mid2", "anus", "mid4", "tailbase", "tailtip")
```

Function to read in the main data table for each animal, get the values of different parameters at the tail, then get the medians across each tail beat cycle.
```{r}
read_tailbeat_data <- function(filename, treatment) {
  df <- read_csv(filename, col_types = list(Animal = col_character(),
                                  Treatment = col_factor(levels = timepoints),
                                  bodyparts = col_factor(levels = bodypartorder),
                                  curve = col_number()))
  

  tailbeatdata <-
    df %>%
    rename(timepoint = Treatment) %>%
    arrange(trial, frame, bodyparts) %>%
    group_by(Animal, timepoint, Date, trial, frame) %>%
    summarize(across(c(len,amp, cycle_num), ~ last(na.omit(.x))),
              across(c(freq,swimvel, wavespeed, wavelength), ~ mean(.x, na.rm = TRUE)),
              curve.mn = mean(curve, na.rm=TRUE)) %>%
    group_by(trial) %>%
    mutate(ncycles = max(cycle_num, na.rm = TRUE),
           iszerofreq = any(freq == 0, na.rm = TRUE)) %>%
    ungroup()

  tailbeatdata %>%
    filter(freq > 0.1 & freq < 5) %>%
    group_by(Animal, Date, timepoint, trial, cycle_num) %>%
    summarize(across(c(freq, amp, swimvel, wavespeed, wavelength, len), ~ median(.x, na.rm = TRUE))) %>%
    mutate(St = 2*freq*amp / swimvel,
           stridelen = swimvel/len / freq,
           slip = swimvel / wavespeed,
           treatment = treatment) %>%
    ungroup()
}
```
  
Load in the four data files.
```{r}
data <- map2_dfr(datafiles, treatments, 
                 ~ read_tailbeat_data(file.path(boxdir, .x), .y))
```
Correct some issues with the dates and animal numbers.
```{r}
data <-
  data %>%
  mutate(Date = case_when(Date == ymd('20210630')  ~  ymd('20210629'),
                          Date == ymd('20210702')  ~  ymd('20210629'),
                          TRUE  ~  Date),
         Animal = if_else(Animal %in% c('1', '2'),
                          paste0(Animal, strftime(Date, format='%m%d')),
                          Animal))
```

```{r}
data %>%
  filter(timepoint %in% c('Control', '2hpi', '3dpi')) %>%
  ggplot(aes(x = timepoint, y = swimvel, color = treatment)) +
  geom_boxplot(aes(color = treatment)) +
  geom_violin(aes(x = timepoint, color = paste(treatment, Animal)), width = 0.8) +
  stat_summary(aes(group = treatment), position = position_dodge(width = 0.8), fun = 'median', geom = 'line')
```

```{r}
data %>%
  filter(timepoint %in% c('Control', '2hpi', '3dpi'))  %>%
  ungroup() %>%
  ggplot(aes(x = timepoint, y = slip)) +
  geom_boxplot(aes(color = treatment)) +
  geom_violin(aes(color = paste(treatment, Animal)), width = 0.8) +
  stat_summary(aes(group = treatment, color = treatment), position = position_dodge(width = 0.8), fun = 'median', geom = 'line') +
  ylim(0, 4)

# 
# %>%
#   ggplot(aes(x = timepoint, y = wavespeed, color = treatment)) +
#   geom_boxplot(aes(color = treatment)) +
#   geom_violin(aes(x = timepoint, color = paste(treatment, Animal)), width = 0.8) +
#   stat_summary(aes(group = treatment), position = position_dodge(width = 0.8), fun = 'median', geom = 'line') +
#   ylim(0,1)
```
```{r}
data %>%
  filter(timepoint %in% c('Control', '2hpi', '3dpi')) %>%
  ggplot(aes(x = timepoint, y = freq, color = treatment)) +
  geom_boxplot(aes(color = treatment)) +
  geom_violin(aes(x = timepoint, color = paste(treatment, Animal)), width = 0.8) +
  stat_summary(aes(group = treatment), position = position_dodge(width = 0.8), fun = 'median', geom = 'line')
```

```{r}
data %>%
  filter(Animal == '10629') %>%
  get_amplitude_envelope()
```


