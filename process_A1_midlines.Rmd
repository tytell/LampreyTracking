---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(tidyverse)
# library(signal)
library(plotly)
library(patchwork)
library(ggbeeswarm)
```

This is a script with the kinematics processing code.
```{r}
source('process_midlines.R')
```

Directory where all the tracked data files are stored.
```{r}
boxdir <- '/Users/etytel01/Box/Katz lamprey kinematics/'
datadir <- file.path(boxdir,'2021/Processed Data')
```

Names of the treatments.
```{r}
treatments = c("Control", "2hpi", "1dpi", "2dpi", "3dpi")
```

Body parts are named in DeepLabCut, but they have an order along the body, given here.
```{r}
bodypartorder = c("snout", "gill", "mid1", "mid2", "anus", "mid4", "tailbase", "tailtip")
```

Filming speed (frames per second)
```{r}
fps = 60
```

Load in approximate widthdata for ammocoetes, which we'll use for locating the center of mass.
```{r}
widthdata <- read_csv(file.path(boxdir,'2021/fishwidth.csv'))
```

Digitized scales for each day of filming.
```{r}
scalefile <- file.path(boxdir,'2021/Processed Data/scales.csv')
```

```{r}
scales <- read_csv(scalefile, col_types = list(Date = col_date("%m/%d/%y"),
                                               Animal = col_character(),
                                               Treatment = col_factor(levels = treatments)))
scales
```

# Load the DeepLabCut data and process it

```{r}
datafilenames <- list.files(datadir, pattern='*.csv', full.names = TRUE, recursive = TRUE)
datafilenames <- datafilenames[str_detect(datafilenames, 'shuffle1')]
```

```{r}
datafilenames <- datafilenames[str_detect(datafilenames, 'A1')]
```

## Load and process the data

Note that these chunks don't run by default, since they take a long time.

```{r eval = FALSE}
#options(error = recover)
data <- purrr::map_dfr(datafilenames, ~ load_katz_data(.x, widthdata = widthdata$ammowidth, fps = fps,
                 bodypartorder = bodypartorder, showfile = TRUE))
write_csv(data, file.path(boxdir,'Processed Data/A1data.csv')
```

This loads the previous processed data file, as produced above.
```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A1data.csv'))
```

## Look for bad frames

Look for variation in length
```{r}
animallengths <-
  data %>%
  get_arc_length() %>%
  group_by(Animal, trial, frame) %>%
  summarize(lenfr = last(s)) %>%
  ungroup() %>%
  group_by(Animal) %>%
  mutate(len = median(lenfr)) %>%
  ungroup()
```

```{r}
data <-
  data %>%
  left_join(animallengths, by = c("Animal","trial","frame"))
```

This also takes a long time
```{r eval=FALSE}
data <-
  data %>%
  get_point_order()
write_csv(data, file.path(boxdir,'2021/Processed Data/A1data.csv'))
```

```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A1data.csv'), 
                 col_types = list(Animal = col_character(),
                                  Treatment = col_factor(levels = treatments),
                                  bodyparts = col_factor(levels = bodypartorder)))
```

```{r}
data <-
  data %>%
  group_by(trial, frame) %>%
  mutate(pointorder = seq_len(n())) %>%
  mutate(goodpointorder = all(nextpoint == pointorder+1, na.rm=TRUE),
            goodlength = all(abs(lenfr - len) / len < 0.1))
```

## Process the kinematics for the good frames

```{r eval = FALSE}
data <-
  data %>%
  ungroup() %>%
  select(-(dx:wavelength)) %>%
   filter(goodpointorder & goodlength) %>%
  group_by(filename) %>%
  group_modify(~ get_all_kinematics(.x, widthdata = widthdata$ammowidth))
write_csv(data, file.path(boxdir,'2021/Processed Data/A1data-goodframes.csv'))
```


# Plot kinematics

```{r}
data <- read_csv(file.path(boxdir,'2021/Processed Data/A1data-goodframes.csv'),
                 col_types = list(Date = col_date(), 
                                  Animal = col_character(),
                                  Treatment = col_factor(levels = treatments),
                                  bodyparts = col_factor(levels = bodypartorder)))
```

```{r}
data %>%
  plot_ly(x = ~t, y = ~swimvel, color = ~trial, type = 'scatter', mode = 'lines') %>%
  layout(showlegend = FALSE)
```

```{r}
data %>%
  group_by(trial, frame) %>%
  summarize(across(c(freq,swimvel,Treatment), first)) %>%
  plot_ly(x = ~freq, y = ~swimvel, color = ~trial, type = 'scatter', mode = 'markers',
          hovertemplate = '%{swimvel}') %>%
  layout(showlegend = FALSE)
```

```{r}
data %>%
  filter(trial == '070221_A1V03_03') %>%
  group_by(trial, frame) %>%
  #summarize(across(c(freq,swimvel,comx,comy,t,Treatment), first)) %>%
  # filter(bodyparts == 'tailtip') %>%
  plot_ly(x = ~xmm, y = ~ymm, type = 'scatter', mode = 'lines')
```

```{r}
data %>%
  filter(trial == '070221_A1V03_03') %>%
  group_by(bodyparts) %>%
  mutate(
    excs = smooth_com_spline(t, exc, 0.3), 
    peak = case_when((excs > lag(excs)) & (excs > lead(excs))   ~  1,
                          (excs < lag(excs)) & (excs < lead(excs))   ~  -1,
                          TRUE   ~  0)) %>%
  filter(bodyparts == 'tailtip') %>%
  plot_ly(x = ~t, y = ~excs, color = ~factor(peak), group=1, type = 'scatter', mode = 'lines+markers')
```

```{r}
df <- data %>%
  filter(trial == '070221_A1V03_03')
smooth.excursion <- 0.2
min.peak.gap <- 0.01
```

```{r}
df <-
  df %>%
  group_by(bodyparts, .add=TRUE) %>%
  mutate(excs = smooth_point_spline(t, exc, smooth.excursion),
         peak = case_when((excs > lag(excs)) & (excs > lead(excs))   ~  1,
                          (excs < lag(excs)) & (excs < lead(excs))   ~  -1,
                          TRUE   ~  0),
         excn = lead(exc),
         zerocross = case_when(sign(excn) > sign(exc)   ~   1,
                               sign(excn) == sign(exc)  ~   0,
                               sign(excn) < sign(exc)   ~   -1,
                               TRUE   ~   0)) %>%
  ungroup(bodyparts)
```

```{r}
df %>%
  filter(bodyparts == 'tailtip') %>%
  group_by(bodyparts) %>%
  ggplot(aes(x = t, y = excs)) +
  geom_line() +
  geom_point(data = filter(df, bodyparts == 'tailtip' & (peak != 0 | zerocross != 0)), aes(x = t, y = excs))
```

```{r}
# formula from https://stackoverflow.com/questions/717762/how-to-calculate-the-vertex-of-a-parabola-given-three-points   
df <-
  df %>%
  ungroup() %>%
  arrange(bodyparts, t) %>%
  group_by(bodyparts) %>%
  mutate(denom = if_else(peak != 0, 
                         (lag(t) - t) * (lag(t) - lead(t)) * (t - lead(t)), 
                         NA_real_),
         A = if_else(peak != 0, 
                     (lead(t) * (excs - lag(excs)) + t * (lag(excs) - lead(excs)) + lag(t) * (lead(excs) - excs)) / denom, 
                     NA_real_),
         B = if_else(peak != 0,
                     (lead(t)^2 * (lag(excs) - excs) + t^2 * (lead(excs) - lag(excs)) + lag(t)^2 * (excs - lead(excs))) / denom,
                     NA_real_),
         tp = -B / (2*A),
         t0 = if_else(zerocross != 0,
                      t + (lead(t) - t) / (lead(excs) - excs) * (0-excs),
                      NA_real_))
```

```{r}
df %>%
  filter(bodyparts == 'tailtip') %>%
  ggplot(aes(x = t, y = excs)) +
  geom_line() +
  geom_point(aes(x = t0, y = 0), color='red') +
  geom_point(aes(x = tp, y = excs), color='blue')
```
```{r}
cycleorder <-
  df %>%
  group_by(bodyparts, .add=TRUE) %>%
  filter((peak != 0) | (zerocross != 0)) %>%
  mutate(tp2 = if_else(lead(tp) - tp < min.peak.gap |
                        tp - lag(tp) < min.peak.gap, NA_real_, tp),
         tp = tp2) %>%
  select(-tp2) %>%
  mutate(peak = if_else(is.na(tp), 0, peak))
```

```{r}
cycleorder <-
  cycleorder %>%
  filter((peak != 0) | (zerocross != 0)) %>%
  group_by(bodyparts, .add=TRUE) %>%
  mutate(cycle_step = case_when(zerocross == 1  ~  'up',
                                peak == 1  ~  'max',
                                zerocross == -1  ~  'down',
                                peak == -1  ~  'min'),
         cycle_step = factor(cycle_step, levels = c('up', 'max', 'down', 'min')),
         tph = case_when(peak != 0  ~  tp,
                         zerocross != 0  ~  t0),
         ph1 = case_when(cycle_step == 'up'  ~  0,
                         cycle_step == 'max'  ~  0.25,
                         cycle_step == 'down'  ~  0.5,
                         cycle_step == 'min'  ~  0.75)) %>%
  arrange(frame, by_group = TRUE) %>%
  mutate(cycle_num_step = as.integer(as.integer(cycle_step) < as.integer(lag(cycle_step))),
         cycle_num_step = replace_na(cycle_num_step, 0),
         cycle_num = cumsum(cycle_num_step),
         ph1 = ph1 + cycle_num) %>%
  select(bodyparts, frame, cycle_step, tph, cycle_num, ph1)
```


```{r}
sf_tail <- with(filter(cycleorder, bodyparts == 'tailtip'),
                splinefun(tph, ph1, method = 'natural'))

```

```{r}
df <-
  df %>%
  left_join(cycleorder, by = c("bodyparts", "frame")) %>%
  mutate(phase = sf_tail(t))
```

```{r}
df %>%
  filter(bodyparts == 'tailtip') %>%
  ggplot(aes(x = t, y = excs)) +
  geom_line() +
  geom_point(aes(x = t0, y = 0), color='red') +
  geom_point(aes(x = tp, y = excs), color='blue') +
  geom_line(aes(x = t, y = phase)) +
  geom_point(data = filter(cycleorder, bodyparts == 'tailtip'), aes(x = t, y = ph1))

```
```{r}
data %>%
  select(-(excn:cycle)) %>%
  filter(trial == '070221_A1V03_03') %>%
  get_cycles()
```

```{r}
data %>%
  filter(trial == '070221_A1V03_03') %>%
  get_cycles()
```

